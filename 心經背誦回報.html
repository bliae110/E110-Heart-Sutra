<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課文背誦次數統計</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- 應用程式結構說明：此版本已包含修正後的 Firebase 認證流程，優先使用 Canvas 提供的 Custom Token 登入，確保資料庫權限正常運作。 -->
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .tab-active { border-color: #0d9488; color: #0d9488; background-color: #f0fdfa; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-amber-50 text-stone-800">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-teal-800">課文背誦 功課回報</h1>
            <p class="text-stone-600 mt-2 text-lg">請選擇您的姓名並填寫本次背誦次數</p>
        </header>

        <div class="mb-6">
            <div class="border-b border-stone-200">
                <nav class="-mb-px flex gap-x-6" aria-label="Tabs">
                    <button id="tab-submit" class="whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-xl tab-active">
                        回報次數
                    </button>
                    <button id="tab-records" class="whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-xl text-stone-500 hover:text-teal-700 hover:border-stone-300">
                        查看紀錄
                    </button>
                </nav>
            </div>
        </div>

        <main>
            <div id="view-submit">
                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                    <form id="recitation-form" class="space-y-6">
                        <div>
                            <label for="name-select" class="block text-lg font-medium text-stone-700 mb-2">姓名</label>
                            <select id="name-select" class="block w-full p-4 text-lg border-stone-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500">
                                <option value="">--- 請選擇姓名 ---</option>
                                <option value="new-user">我是新來的，要新增姓名</option>
                            </select>
                            <input type="text" id="new-name-input" placeholder="請在此輸入您的姓名" class="hidden mt-3 block w-full p-4 text-lg border-stone-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500">
                        </div>

                        <div>
                            <label for="count-input" class="block text-lg font-medium text-stone-700 mb-2">本次背誦次數</label>
                            <div class="flex items-center gap-x-4">
                                <button type="button" id="btn-minus" class="p-3 bg-stone-200 rounded-full text-2xl font-bold text-stone-700 hover:bg-stone-300 transition-colors">-</button>
                                <input type="number" id="count-input" value="1" min="1" class="w-full text-center text-2xl font-bold p-3 border-stone-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500">
                                <button type="button" id="btn-plus" class="p-3 bg-stone-200 rounded-full text-2xl font-bold text-stone-700 hover:bg-stone-300 transition-colors">+</button>
                            </div>
                        </div>

                        <div>
                            <button type="submit" class="w-full bg-teal-600 text-white text-xl font-bold py-4 px-6 rounded-xl shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105">
                                送出回報
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="view-records" class="hidden">
                 <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg space-y-8">
                    <div>
                        <h2 class="text-2xl font-bold text-teal-800 mb-4">總覽圖表</h2>
                        <p class="text-stone-600 mb-4">這裡是所有人的總累計背誦次數長條圖，可以一眼看出大家的學習成果！</p>
                        <div class="chart-container" style="position: relative; height: 40vh; max-height: 400px; width: 100%; max-width: 700px; margin: auto;">
                            <canvas id="recitationChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-teal-800 mb-4">詳細記錄</h2>
                        <p class="text-stone-600 mb-4">這裡是所有的回報紀錄，點擊標題可以排序。</p>
                        <div class="overflow-x-auto">
                             <table class="min-w-full divide-y divide-stone-200">
                                <thead class="bg-stone-50">
                                    <tr>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold text-stone-900 cursor-pointer" data-sort="timestamp">時間 ▼</th>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold text-stone-900 cursor-pointer" data-sort="name">姓名</th>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold text-stone-900 cursor-pointer" data-sort="count">本次次數</th>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold text-stone-900 cursor-pointer" data-sort="monthTotal">本月累計</th>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold text-stone-900 cursor-pointer" data-sort="total">總累計</th>
                                    </tr>
                                </thead>
                                <tbody id="records-table-body" class="divide-y divide-stone-200 bg-white">
                                    <tr><td colspan="5" class="text-center p-8 text-stone-500">讀取中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </div>
        </main>

        <footer class="text-center mt-12 text-stone-500 text-sm">
            <p>&copy; 2025 課文背誦功課回報</p>
        </footer>
    </div>
    
    <div id="modal" class="hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl p-8 m-4 max-w-sm w-full text-center">
            <p id="modal-message" class="text-xl text-stone-700 mb-6"></p>
            <button id="modal-close" class="bg-teal-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-teal-700 transition-colors">好</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // 檢查 Canvas 環境變數並初始化 Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'recitation-tracker';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let records = [];
        let chartInstance = null;
        let currentSort = { key: 'timestamp', direction: 'desc' };
        let isDataListenerSetup = false; // 旗標：確保 onSnapshot 只設定一次

        // DOM 元素引用
        const tabSubmit = document.getElementById('tab-submit');
        const tabRecords = document.getElementById('tab-records');
        const viewSubmit = document.getElementById('view-submit');
        const viewRecords = document.getElementById('view-records');
        const nameSelect = document.getElementById('name-select');
        const newNameInput = document.getElementById('new-name-input');
        const countInput = document.getElementById('count-input');
        const form = document.getElementById('recitation-form');
        const recordsTableBody = document.getElementById('records-table-body');
        const btnMinus = document.getElementById('btn-minus');
        const btnPlus = document.getElementById('btn-plus');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalClose = document.getElementById('modal-close');

        // 模態視窗函數，取代 alert
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        modalClose.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // 視圖切換邏輯
        function switchView(view) {
            if (view === 'submit') {
                viewSubmit.classList.remove('hidden');
                viewRecords.classList.add('hidden');
                tabSubmit.classList.add('tab-active');
                tabRecords.classList.remove('tab-active');
            } else {
                viewSubmit.classList.add('hidden');
                viewRecords.classList.remove('hidden');
                tabSubmit.classList.remove('tab-active');
                tabRecords.classList.add('tab-active');
                processAndRenderData();
            }
        }

        tabSubmit.addEventListener('click', () => switchView('submit'));
        tabRecords.addEventListener('click', () => switchView('records'));

        // 處理姓名輸入欄位顯示
        nameSelect.addEventListener('change', () => {
            if (nameSelect.value === 'new-user') {
                newNameInput.classList.remove('hidden');
                newNameInput.focus();
            } else {
                newNameInput.classList.add('hidden');
            }
        });

        // 次數增減按鈕
        btnMinus.addEventListener('click', () => {
            let currentValue = parseInt(countInput.value, 10);
            if (currentValue > 1) {
                countInput.value = currentValue - 1;
            }
        });

        btnPlus.addEventListener('click', () => {
            let currentValue = parseInt(countInput.value, 10);
            countInput.value = currentValue + 1;
        });

        // 提交表單邏輯
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedName = nameSelect.value;
            const newName = newNameInput.value.trim();
            const count = parseInt(countInput.value, 10);

            let finalName = '';
            if (selectedName === 'new-user') {
                if (newName === '') {
                    showModal('請輸入您的姓名！');
                    return;
                }
                finalName = newName;
            } else if (selectedName === '') {
                showModal('請選擇您的姓名！');
                return;
            } else {
                finalName = selectedName;
            }

            if (isNaN(count) || count <= 0) {
                showModal('背誦次數必須是正數！');
                return;
            }

            try {
                // 使用 public collection 讓所有使用者能看到數據
                const collectionRef = collection(db, `artifacts/${appId}/public/data/logs`);
                await addDoc(collectionRef, {
                    name: finalName,
                    count: count,
                    timestamp: serverTimestamp()
                });
                showModal('回報成功！感謝您的努力！');
                form.reset();
                newNameInput.classList.add('hidden');
            } catch (error) {
                console.error("Error adding document: ", error);
                showModal('回報失敗，請稍後再試。');
            }
        });

        // 處理數據：計算總計、本月累計並觸發渲染
        function processAndRenderData() {
            if (records.length === 0) {
                recordsTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-stone-500">目前沒有任何紀錄。</td></tr>';
                return;
            }
            
            const nameTotals = {};
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            records.forEach(rec => {
                // 確保 timestamp 是一個有效的 Firestore Timestamp 物件
                if (rec.timestamp && typeof rec.timestamp.toDate === 'function') {
                    const recDate = rec.timestamp.toDate();
                    const recMonth = recDate.getMonth();
                    const recYear = recDate.getFullYear();

                    if (!nameTotals[rec.name]) {
                        nameTotals[rec.name] = { total: 0, monthTotal: 0 };
                    }
                    
                    nameTotals[rec.name].total += rec.count;
                    if (recMonth === currentMonth && recYear === currentYear) {
                        nameTotals[rec.name].monthTotal += rec.count;
                    }
                }
            });

            // 過濾掉還沒有 serverTimestamp 的記錄 (例如：正在寫入中的文件)
            let displayData = records.filter(rec => rec.timestamp && typeof rec.timestamp.toDate === 'function').map(rec => {
                const userTotals = nameTotals[rec.name];
                return {
                    ...rec,
                    total: userTotals ? userTotals.total : 0,
                    monthTotal: userTotals ? userTotals.monthTotal : 0
                };
            });
            
            sortData(displayData);
            renderTable(displayData);
            renderChart(nameTotals);
        }
        
        // 資料排序邏輯
        function sortData(data) {
            data.sort((a, b) => {
                let valA = a[currentSort.key];
                let valB = b[currentSort.key];

                if (currentSort.key === 'timestamp') {
                    // 對 Timestamp 進行毫秒比較
                    valA = a.timestamp.toMillis();
                    valB = b.timestamp.toMillis();
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // 渲染表格
        function renderTable(data) {
            recordsTableBody.innerHTML = '';
            data.forEach(rec => {
                const tr = document.createElement('tr');
                const formattedDate = rec.timestamp.toDate().toLocaleString('zh-TW');

                tr.innerHTML = `
                    <td class="whitespace-nowrap py-4 px-3 text-sm text-stone-500">${formattedDate}</td>
                    <td class="whitespace-nowrap py-4 px-3 text-sm font-medium text-stone-900">${rec.name}</td>
                    <td class="whitespace-nowrap py-4 px-3 text-sm text-stone-500">${rec.count}</td>
                    <td class="whitespace-nowrap py-4 px-3 text-sm text-stone-500">${rec.monthTotal}</td>
                    <td class="whitespace-nowrap py-4 px-3 text-sm text-stone-500">${rec.total}</td>
                `;
                recordsTableBody.appendChild(tr);
            });
        }
        
        // 表格標頭排序事件處理
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', (e) => {
                const key = e.target.dataset.sort;
                if (currentSort.key === key) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = key;
                    currentSort.direction = 'desc';
                }
                // 更新排序標記
                document.querySelectorAll('th[data-sort]').forEach(header => header.textContent = header.textContent.replace(/[▲▼]/g, '').trim());
                e.target.textContent += ` ${currentSort.direction === 'desc' ? '▼' : '▲'}`;
                processAndRenderData();
            });
        });

        // 渲染 Chart.js 長條圖
        function renderChart(nameTotals) {
            const ctx = document.getElementById('recitationChart').getContext('2d');
            const sortedNames = Object.keys(nameTotals).sort((a, b) => nameTotals[b].total - nameTotals[a].total);
            const labels = sortedNames;
            const data = sortedNames.map(name => nameTotals[name].total);

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '總累計次數',
                        data: data,
                        backgroundColor: 'rgba(13, 148, 136, 0.6)',
                        borderColor: 'rgba(15, 118, 110, 1)',
                        borderWidth: 1,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e7e5e4'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 },
                            padding: 12,
                            cornerRadius: 8,
                        }
                    }
                }
            });
        }
        
        // ** Firebase 身份驗證邏輯 **
        async function initialAuth() {
            try {
                // 優先使用 Canvas 提供的 Custom Token 進行登入
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // 如果沒有 Custom Token，則使用匿名登入
                    await signInAnonymously(auth);
                }
            } catch(error) {
                console.error("Firebase authentication failed:", error);
            }
        }
        
        // 監聽認證狀態變化，只在成功登入後設定一次資料監聽器
        onAuthStateChanged(auth, (user) => {
            if (user && !isDataListenerSetup) {
                isDataListenerSetup = true; 
                
                const collectionRef = collection(db, `artifacts/${appId}/public/data/logs`);
                // 移除 orderBy，避免因缺少索引導致權限錯誤 (Permission Denied Fix)
                const q = query(collectionRef); 
                
                onSnapshot(q, (querySnapshot) => {
                    // 更新 records 陣列
                    records = querySnapshot.docs.map(doc => doc.data());
                    
                    // 更新姓名下拉選單
                    const uniqueNames = [...new Set(records.map(rec => rec.name))].sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                    nameSelect.innerHTML = `
                        <option value="">--- 請選擇姓名 ---</option>
                        ${uniqueNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                        <option value="new-user">我是新來的，要新增姓名</option>
                    `;
                    
                    // 如果用戶正在觀看紀錄頁面，則立即更新數據和圖表
                    if(viewRecords.classList.contains('hidden') === false){
                        processAndRenderData();
                    }
                }, (error) => {
                    console.error("@firebase/firestore: Snapshot Listener Error:", error);
                });
            }
        });

        // 啟動初始身份驗證流程
        initialAuth();

    </script>
</body>
</html>